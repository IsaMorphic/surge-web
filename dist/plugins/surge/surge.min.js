function concat(e){let t=0;for(const r of e)t+=r.byteLength;let r=new Uint8Array(t),n=0;for(const t of e){const e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);r.set(e,n),n+=e.byteLength}return r}ReadableStream.prototype[Symbol.asyncIterator]=async function*(){const e=this.getReader();try{for(;;){const{done:t,value:r}=await e.read();if(t)return;yield r}}finally{e.releaseLock()}};const surgePlugin={invocCount:0,maxWorkers:4,workers:[],getWorker:function(){if(this.workers[this.invocCount%this.maxWorkers])return this.workers[this.invocCount++%this.maxWorkers];{const e=new Worker("/plugins/surge/surge-worker.min.js");return this.workers.push(e),++this.invocCount,e}},parse:async function*(e){const t=await fetch(e,{headers:{Accept:"application/x-cfs-surge"}});if("application/x-cfs-surge"!=t.headers.get("Content-Type"))return;const r=t.body.getReader();let n=(await r.read()).value;const a=new Int32Array(n.buffer,0,4),s=function e(t,r){return 0==r?t:e(r,t%r)}(a[1],a[2]);header={magic:a[0],width:a[1],height:a[2],avgPixel:a[3],layers:Array.from(function*(e){for(let t=2;t<=Math.sqrt(e);t++)for(;e%t==0;)yield t,e/=t;e>1&&(yield e)}(s))};const o=[...new Uint32Array(n.buffer,16,header.layers.length+1)];header.segmentSizes=[...o],yield header,n=new Uint8Array(n.buffer,16+4*header.layers.length+4);const i=new ReadableStream({async pull(e){let t=!1,a=o.shift();for(;!t;){const s=await r.read();if(!s.done){const e=s.value;n=concat([n,e])}if(n.byteLength>=a){const r=n.slice(0,a);e.enqueue(r),n=new Uint8Array(n.buffer,n.byteOffset+a),t=!0}else s.done&&(t=!0,e.close())}}});for await(const e of i)yield new Int32Array(e.buffer,e.byteOffset)},decode:function(e,t,r,n,a,s){return new Promise(((o,i)=>{e.addEventListener("message",(e=>{e.data.workerId==t&&e.data.currLayerIdx==s&&o(e.data.imageBitmap)})),e.postMessage({workerId:t,imageData:r,layers:n,layerBuffer:a,maxLayerIdx:s},[a])}))},main:async function(e){let t,r,n,a;const s=[],o=e.classList??[],i=e.getAttribute("id"),c=e.getAttribute("alt"),l=e.getAttribute("src"),f=l+"-"+Date.now(),d=this.getWorker();for await(const u of this.parse(l))if(u instanceof Int32Array){const e=s.length-1;s.push(u);const t=concat(s).buffer,o=await this.decode(d,f,e>0?null:a,n.layers,t,e);r.clearRect(0,0,o.width,o.height),r.drawImage(o,0,0),o.close()}else{if(n=u,t=document.createElement("canvas"),r=t.getContext("2d"),i&&t.setAttribute("id",i),c){t.setAttribute("role","img"),t.setAttribute("aria-label",c);const e=document.createElement("p");e.innerText=c,t.appendChild(e)}o.length>0&&(t.classList=o),t.width=n.width,t.height=n.height,e.parentElement.appendChild(t),e.remove(),a=r.getImageData(0,0,n.width,n.height);const s=(2130706432&n.avgPixel)<<1|16777215&n.avgPixel;for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++)for(let r=0;r<4;r++)a.data[4*(e*n.width+t)+r]=s>>8*r&255}}};new MutationObserver((e=>e.forEach((e=>e.addedNodes.forEach((e=>{e instanceof HTMLImageElement&&(e.onerror=()=>surgePlugin.main(e))})))))).observe(document.documentElement,{subtree:!0,childList:!0});