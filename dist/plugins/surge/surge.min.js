function concat(e){let t=0;for(const r of e)t+=r.byteLength;let r=new Uint8Array(t),n=0;for(const t of e){const e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);r.set(e,n),n+=e.byteLength}return r}ReadableStream.prototype[Symbol.asyncIterator]=async function*(){const e=this.getReader();try{for(;;){const{done:t,value:r}=await e.read();if(t)return;yield r}}finally{e.releaseLock()}};const surgePlugin={invocCount:0,maxWorkers:4,workers:[],getWorker:function(){if(this.workers[this.invocCount%this.maxWorkers])return this.workers[this.invocCount++%this.maxWorkers];{const e=new Worker("/plugins/surge/surge-worker.min.js");return this.workers.push(e),e}},parse:async function*(e){const t=await fetch(e,{headers:{Accept:"application/x-cfs-surge"}});if("application/x-cfs-surge"!=t.headers.get("Content-Type"))return;const r=t.body.getReader();let n=(await r.read()).value;const a=new Int32Array(n.buffer,0,4),s=function e(t,r){return 0==r?t:e(r,t%r)}(a[1],a[2]);header={magic:a[0],width:a[1],height:a[2],avgPixel:a[3],layers:Array.from(function*(e){for(let t=2;t<=Math.sqrt(e);t++)for(;e%t==0;)yield t,e/=t;e>1&&(yield e)}(s))};const i=[...new Uint32Array(n.buffer,16,header.layers.length+1)];header.segmentSizes=[...i],yield header,n=new Uint8Array(n.buffer,16+4*header.layers.length+4);const o=new ReadableStream({async pull(e){let t=!1,a=i.shift();for(;!t;){const s=await r.read();if(!s.done){const e=s.value;n=concat([n,e])}if(n.byteLength>=a){const r=n.slice(0,a);e.enqueue(r),n=new Uint8Array(n.buffer,n.byteOffset+a),t=!0}else s.done&&(t=!0,e.close())}}});for await(const e of o)yield new Int32Array(e.buffer,e.byteOffset)},decode:function(e,t,r,n,a,s){return new Promise(((i,o)=>{e.addEventListener("message",(e=>{e.data.workerId==t&&e.data.currLayerIdx==s&&i(e.data.imageBitmap)})),e.postMessage({workerId:t,imageData:r,layers:n,layerBuffer:a,maxLayerIdx:s})}))},main:async function(e){let t,r,n,a,s=null,i=-1;const o=e.classList??[],c=e.getAttribute("id"),l=e.getAttribute("alt"),f=e.getAttribute("src"),d=f+"-"+Date.now(),u=this.getWorker();for await(const h of this.parse(f))if(h instanceof Int32Array){s=null==s?h:new Int32Array(concat([s,h]).buffer);const e=await this.decode(u,d,i>0?null:a,n.layers,s.buffer,i++);r.clearRect(0,0,e.width,e.height),r.drawImage(e,0,0),e.close()}else{if(n=h,t=document.createElement("canvas"),r=t.getContext("2d"),c&&t.setAttribute("id",c),l){t.setAttribute("role","img"),t.setAttribute("aria-label",l);const e=document.createElement("p");e.innerText=l,t.appendChild(e)}o.length>0&&(t.classList=o),t.width=n.width,t.height=n.height,e.parentElement.appendChild(t),e.remove(),a=r.getImageData(0,0,n.width,n.height);const s=(2130706432&n.avgPixel)<<1|16777215&n.avgPixel;for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++)for(let r=0;r<4;r++)a.data[4*(e*n.width+t)+r]=s>>8*r&255}}};new MutationObserver((e=>e.forEach((e=>e.addedNodes.forEach((e=>{e instanceof HTMLImageElement&&(e.onerror=()=>surgePlugin.main(e))})))))).observe(document.documentElement,{subtree:!0,childList:!0});