function concat(e){let t=0;for(const r of e)t+=r.byteLength;let r=new Uint8Array(t),n=0;for(const t of e){const e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);r.set(e,n),n+=e.byteLength}return r}ReadableStream.prototype[Symbol.asyncIterator]=async function*(){const e=this.getReader();try{for(;;){const{done:t,value:r}=await e.read();if(t)return;yield r}}finally{e.releaseLock()}};const surgePlugin={invocCount:0,maxWorkers:4,workers:[],getWorker:function(){if(this.workers[this.invocCount%this.maxWorkers])return this.workers[this.invocCount++%this.maxWorkers];{const e=new Worker("/plugins/surge/surge-worker.min.js");return this.workers.push(e),++this.invocCount,e}},parse:async function*(e){const t=await fetch(e,{headers:{Accept:"application/x-cfs-surge"}});if("application/x-cfs-surge"!=t.headers.get("Content-Type"))return;const r=t.body.getReader();let n=(await r.read()).value;const a=new Int32Array(n.buffer,0,4),o=function e(t,r){return 0==r?t:e(r,t%r)}(a[1],a[2]);header={magic:a[0],width:a[1],height:a[2],avgPixel:a[3],layers:Array.from(function*(e){for(let t=2;t<=Math.sqrt(e);t++)for(;e%t==0;)yield t,e/=t;e>1&&(yield e)}(o))};const s=[...new Uint32Array(n.buffer,16,header.layers.length+1)];header.segmentSizes=[...s],yield header,n=new Uint8Array(n.buffer,16+4*header.layers.length+4);const i=new ReadableStream({async pull(e){let t=!1,a=s.shift();for(;!t;){const o=await r.read();if(!o.done){const e=o.value;n=concat([n,e])}if(n.byteLength>=a){const r=n.slice(0,a);e.enqueue(r),n=new Uint8Array(n.buffer,n.byteOffset+a),t=!0}else o.done&&(t=!0,e.close())}}});for await(const e of i)yield new Uint8Array(e.buffer,e.byteOffset)},decode:function(e,t,r,n,a){return new Promise(((o,s)=>{t.addEventListener("message",(e=>{e.data.workerId==r&&e.data.currLayerIdx==n&&o(e.data.imageBitmap)})),t.postMessage({header:e,workerId:r,maxLayerIdx:n,layerBuffer:a},a?[a]:[])}))},main:async function(e){let t,r,n;const a=e.getAttribute("alt"),o=e.classList??[],s=e.getAttribute("id"),i=e.getAttribute("src");let c=-1;const d=[],u=i+"-"+Date.now(),l=this.getWorker();async function f(e){const r=e.shouldDecode?concat(d).buffer:null,a=await surgePlugin.decode(t,l,u,c++,r);n.clearRect(0,0,a.width,a.height),n.drawImage(a,0,0),a.close()}for await(const c of this.parse(i))if(c instanceof Uint8Array)d.push(c),await f({shouldDecode:!0});else{if(t=c,r=document.createElement("canvas"),n=r.getContext("2d"),s&&r.setAttribute("id",s),a){r.setAttribute("role","img"),r.setAttribute("aria-label",a);const e=document.createElement("p");e.innerText=a,r.appendChild(e)}o.length>0&&(r.classList=o),r.width=t.width,r.height=t.height,e.parentElement.appendChild(r),e.remove()}await f({shouldDecode:!1})}};new MutationObserver((e=>e.forEach((e=>e.addedNodes.forEach((e=>{e instanceof HTMLImageElement&&(e.onerror=()=>surgePlugin.main(e))})))))).observe(document.documentElement,{subtree:!0,childList:!0});