this.data={layerIndices:{},imageData:{}},onmessage=async t=>{function a(t,e){return 0==e?t:a(e,t%e)}const e=t.data.header,i=t.data.workerId,r=t.data.maxLayerIdx,h=t.data.layerBuffer,d=h?new Int32Array(h):null,l=this.data.imageData[i]??new ImageData(e.width,e.height),s=e.width/a(e.width,e.height),n=e.height/a(e.width,e.height);let o=this.data.layerIndices[i]??-1;if(o<0){const t=(2130706432&e.avgPixel)<<1|16777215&e.avgPixel;for(let a=0;a<e.height;a++)for(let i=0;i<e.width;i++)for(let r=0;r<4;r++)l.data[4*(a*e.width+i)+r]=t>>8*r&255}function g(t,a,i,r,h,f){const c=a<0?s:e.layers[e.layers.length-(a+1)],w=a<0?n:e.layers[e.layers.length-(a+1)];for(let e=0;e<c;e++)for(let s=0;s<w;s++){let n=d[t++];if(a<o&&(n>0||-2147483648==n)){g(t+(-2147483648==n?0:n>>2),a+1,i+h*e/c,r+f*s/w,h/c,f/w),t++}else if(a==o){n>0||-2147483648==n?n=d[t++]:n<0&&-2147483648!=n&&(n=-n);const a=(2130706432&n)<<1|16777215&n;for(let t=r+f*s/w;t<r+f*(s+1)/w;t++)for(let r=i+h*e/c;r<i+h*(e+1)/c;r++)for(let e=0;e<4;e++)l.data[4*(t*l.width+r)+e]+=2*((a>>8*e&255)<<24>>24)}}}for(;o<=r;o++){const t=await createImageBitmap(l);postMessage({workerId:i,currLayerIdx:o,imageBitmap:t},[t]),d&&g(0,-1,0,0,e.width,e.height)}this.data.layerIndices[i]=o,this.data.imageData[i]??=l};